---
# This include_vars allows you to keep your vaulted variables outside of your main repo
# It assumes the PRIVATE_REPO environment variable is set to the path of your private repo
# On home-infra, this is done by firstrun.sh.
# However, this role will not break if you do not have these
- name: Include vaulted password file
  ansible.builtin.include_vars:
    file: "{{ item }}"
  with_first_found:
    - files:
        - "{{ lookup('env', 'PRIVATE_REPO') | default('~') }}/{{ ansible_vault }}/{{ ansible_role_name }}-vars.yml"
      skip: true

- name: "Ensure ntfs-3g is present in order to support import from NTFS formatted drives"
  ansible.builtin.apt:
    name:
      - ntfs-3g
    state: present
    update_cache: true

- name: "Template the immich.yml file to the role's files/ directory"
  ansible.builtin.template:
    src: immich.yml.j2
    dest: "{{ role_path }}/files/immich.yml"
    owner: "{{ interactive_user }}"
    group: "{{ interactive_user }}"
    mode: '0644'
    force: true
  delegate_to: localhost

- name: "Include role to deploy immich-stack to Portainer"
  ansible.builtin.include_role:
    name: waal70.portainer
  vars:
    stack_list:
      - name: immich
        file: immich.yml # file is in files/ of this role

- name: "Return the immich yaml back to its placeholder version"
  ansible.builtin.copy:
    src: immich.yml.placeholder
    dest: "{{ role_path }}/files/immich.yml"
    owner: "{{ interactive_user }}"
    group: "{{ interactive_user }}"
    mode: '0644'
    remote_src: false
    force: true
  delegate_to: localhost

- name: "Create an additional folder under media root to stage images for import"
  ansible.builtin.file:
    path: "{{ immich_media_root }}/todo"
    mode: '0777'
    state: directory

- name: "Set fact for user to run docker exec under and API key file"
  ansible.builtin.set_fact:
    docker_exec_user: "{{ ansible_facts['env'].SUDO_USER | default(ansible_facts['env'].USER, true) | default(ansible_facts['user_id'], true) }}"
    immich_api_keyfile: "{{ immich_media_root }}/.api"

- name: "Ensure the API-key is present"
  ansible.builtin.copy:
    content: "{{ immich_api_key }}"
    dest: "{{ immich_api_keyfile }}"
    owner: "{{ docker_exec_user }}"
    group: "{{ docker_exec_user }}"
    mode: "0600"
  when: immich_api_key != 'NOTSET'

- name: "Template out the import batch-file to the media root"
  ansible.builtin.template:
    src: import_todo.sh.j2
    dest: "{{ immich_media_root }}/import_todo.sh"
    owner: "{{ docker_exec_user }}"
    group: "{{ docker_exec_user }}"
    mode: '0744'
  when: immich_api_key != 'NOTSET'

- name: "Schedule a regular import of files in todo in cron"
  ansible.builtin.cron:
    name: "immich image import"
    minute: "0"
    hour: "2"
    user: "{{ docker_exec_user }}"
    job: "{{ immich_media_root }}/import_todo.sh >> /home/{{ docker_exec_user }}/crontab.log 2>&1"
    state: "present"
  when: immich_api_key != 'NOTSET'

- name: "Include role to create NFS shares for Immich"
  ansible.builtin.include_role:
    name: waal70.nfs
  vars:
    nfs_exports: ['{{ immich_media_root }} 172.16.10.2(rw,sync,no_subtree_check,no_root_squash)']
